"use strict";(self.webpackChunklinea_legal_specs=self.webpackChunklinea_legal_specs||[]).push([[8895],{3905:(e,a,n)=>{n.d(a,{Zo:()=>p,kt:()=>k});var t=n(7294);function r(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function i(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,t)}return n}function o(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?i(Object(n),!0).forEach((function(a){r(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function l(e,a){if(null==e)return{};var n,t,r=function(e,a){if(null==e)return{};var n,t,r={},i=Object.keys(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||(r[n]=e[n]);return r}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=t.createContext({}),c=function(e){var a=t.useContext(s),n=a;return e&&(n="function"==typeof e?e(a):o(o({},a),e)),n},p=function(e){var a=c(e.components);return t.createElement(s.Provider,{value:a},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},m=t.forwardRef((function(e,a){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(n),m=r,k=u["".concat(s,".").concat(m)]||u[m]||d[m]||i;return n?t.createElement(k,o(o({ref:a},p),{},{components:n})):t.createElement(k,o({ref:a},p))}));function k(e,a){var n=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var l={};for(var s in a)hasOwnProperty.call(a,s)&&(l[s]=a[s]);l.originalType=e,l[u]="string"==typeof e?e:r,o[1]=l;for(var c=2;c<i;c++)o[c]=n[c];return t.createElement.apply(null,o)}return t.createElement.apply(null,n)}m.displayName="MDXCreateElement"},9820:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var t=n(7462),r=(n(7294),n(3905));const i={id:"services",title:"Servicios",sidebar_label:"Servicios"},o=void 0,l={unversionedId:"services",id:"services",title:"Servicios",description:"Firebase",source:"@site/docs/services.md",sourceDirName:".",slug:"/services",permalink:"/docs/services",draft:!1,tags:[],version:"current",frontMatter:{id:"services",title:"Servicios",sidebar_label:"Servicios"},sidebar:"someSidebar",previous:{title:"Regex y enums",permalink:"/docs/regex"},next:{title:"Notificaciones",permalink:"/docs/notifications"}},s={},c=[{value:"Firebase",id:"firebase",level:2},{value:"API keys",id:"api-keys",level:3},{value:"Para frontend",id:"para-frontend",level:4},{value:"Para servidor",id:"para-servidor",level:4},{value:"Configuraci\xf3n SDK",id:"configuraci\xf3n-sdk",level:3},{value:"Token verification (server side)",id:"token-verification-server-side",level:3},{value:"Autenticaci\xf3n",id:"autenticaci\xf3n",level:3},{value:"Tipos de usuario",id:"tipos-de-usuario",level:2},{value:"Stripe",id:"stripe",level:2},{value:"API keys",id:"api-keys-1",level:3},{value:"Crear intenci\xf3n de Pago",id:"crear-intenci\xf3n-de-pago",level:3},{value:"Crear intenci\xf3n de configuraci\xf3n",id:"crear-intenci\xf3n-de-configuraci\xf3n",level:3},{value:"Crear un cargo recurrente",id:"crear-un-cargo-recurrente",level:3},{value:"Tokenizaci\xf3n y pagos en l\xednea",id:"tokenizaci\xf3n-y-pagos-en-l\xednea",level:3},{value:"Tarjetas de prueba",id:"tarjetas-de-prueba",level:3}],p={toc:c},u="wrapper";function d(e){let{components:a,...n}=e;return(0,r.kt)(u,(0,t.Z)({},p,n,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"firebase"},"Firebase"),(0,r.kt)("p",null,"Firebase ser\xe1 usado como un m\xe9todo de autenticaci\xf3n de terceros, permiti\xe9ndonos autenticar usuarios con rol y clientes por igual."),(0,r.kt)("p",null,"La mayor parte de la interacci\xf3n entre firebase y Linea Legal estar\xe1 en el frontend usando los SDK oficiales, sin embargo, hay tres pasos que se deben hacer en el lado del servidor:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Validar Firebase JWT en cada solicitud de API.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Compruebe si el token est\xe1 asociado a un usuario existente a trav\xe9s del identificador uid.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Compruebe si el usuario tiene las reclamaciones correctas."))),(0,r.kt)("h3",{id:"api-keys"},"API keys"),(0,r.kt)("h4",{id:"para-frontend"},"Para frontend"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Ingrese a la consola de proyecto en firebase."),(0,r.kt)("li",{parentName:"ol"},"Haga clic en el engranaje de la esquina superior izquierda y seleccione ",(0,r.kt)("em",{parentName:"li"},"configuraci\xf3n del proyecto"),"."),(0,r.kt)("li",{parentName:"ol"},"En la ficha general, despl\xe1zate hasta la secci\xf3n de aplicaciones y elige la aplicaci\xf3n web, si no la hay, crea una antes del siguiente paso."),(0,r.kt)("li",{parentName:"ol"},"Copie los ajustes y agr\xe9guelos a su proyecto.")),(0,r.kt)("h4",{id:"para-servidor"},"Para servidor"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Ingrese a su consola de proyecto en firebase."),(0,r.kt)("li",{parentName:"ol"},"Haga clic en el engranaje de la esquina superior izquierda y seleccione ",(0,r.kt)("em",{parentName:"li"},"configuraci\xf3n del proyecto"),"."),(0,r.kt)("li",{parentName:"ol"},"En la pesta\xf1a Cuentas de servicio, elija firebase admin SDK."),(0,r.kt)("li",{parentName:"ol"},"Seleccione Nodejs y haga clic en ",(0,r.kt)("em",{parentName:"li"},"Generar nueva clave privada"),"."),(0,r.kt)("li",{parentName:"ol"},"Descargue el archivo de claves, que se utilizar\xe1 m\xe1s adelante en la instalaci\xf3n del SDK.")),(0,r.kt)("h3",{id:"configuraci\xf3n-sdk"},"Configuraci\xf3n SDK"),(0,r.kt)("p",null,"Los siguientes pasos son usados para configurar el Firebase SDK:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"#Step 1\nnpm install firebase-admin --save\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// Step 2\nconst admin = require('firebase-admin');\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'# Step 3\nexport GOOGLE_APPLICATION_CREDENTIALS="/home/user/Downloads/service-account-file.json"\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"//Step 4\nadmin.initializeApp({\n  credential: admin.credential.applicationDefault(),\n  databaseURL: 'https://<DATABASE_NAME>.firebaseio.com'\n});\n")),(0,r.kt)("h3",{id:"token-verification-server-side"},"Token verification (server side)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// Step 5\n// Getting the uid from the token verification\nadmin.auth().verifyIdToken(idToken)\n.then(function(decodedToken) {\n  let uid = decodedToken.uid;\n  // ...\n}).catch(function(error) {\n  // Handle error\n});\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'// Step 6\n{\n  "iss": "https://securetoken.google.com/fakes-radar",\n  "name": "Orlando Rey",\n  "picture": "https://pbs.twimg.com/profile_images/1014735584005447680/wlZO68RR_normal.jpg",\n  "aud": "fakes-radar",\n  "auth_time": 1530825817,\n  "user_id": "435kj234j9j9gdb3",\n  "sub": "orlandorey@example.com",\n  "iat": 1530914131,\n  "exp": 1530917731,\n  "uid": "346kwrgserg345we45453"\n}\n')),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Instalar el proyecto npm como dependencia."),(0,r.kt)("li",{parentName:"ol"},"Requerir el paquete npm dentro del c\xf3digo."),(0,r.kt)("li",{parentName:"ol"},"Pase el archivo json que contiene las credenciales como variable de entorno."),(0,r.kt)("li",{parentName:"ol"},"Pase la configuraci\xf3n."),(0,r.kt)("li",{parentName:"ol"},"Verificar los tokens JWT."),(0,r.kt)("li",{parentName:"ol"},"Obtener la informaci\xf3n de usuario asociada con el token firebase.")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Puedes consultar la informaci\xf3n completa de Firebase ",(0,r.kt)("a",{parentName:"p",href:"https://firebase.google.com/docs/auth/admin/verify-id-tokens?hl=es"},"here"),".")),(0,r.kt)("h3",{id:"autenticaci\xf3n"},"Autenticaci\xf3n"),(0,r.kt)("p",null,"El proceso de autenticaci\xf3n se llevar\xe1 a cabo mediante la verificaci\xf3n de los tokens JWT recibidos en cada llamada a la API con la firebase admin SDK. Las aplicaciones frontend se encargar\xe1n de fusionar los diferentes proveedores de auth en una sola cuenta (por ejemplo tel\xe9fono y gmail)."),(0,r.kt)("p",null,"Cuando se verifica un token, podemos obtener una amplia gama de informaci\xf3n del usuario como nombre de pila, fotos de perfil, etc. Todo depende del proveedor de autenticaci\xf3n y cu\xe1nta informaci\xf3n ha subido el cliente a cada uno."),(0,r.kt)("h2",{id:"tipos-de-usuario"},"Tipos de usuario"),(0,r.kt)("p",null,"Firebase permite segmentar a los usuarios mediante la adici\xf3n de algunas reclamaciones personalizadas, estas reclamaciones deben ser peque\xf1as piezas de informaci\xf3n para mantener el rendimiento.\nSimplemente utilice el m\xe9todo ",(0,r.kt)("em",{parentName:"p"},"setCustomUserClaims")," como en el siguiente ejemplo:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"//customClaims example\nadmin.auth().setCustomUserClaims(uid, {admin: true}).then(() => {\n  // The new custom claims will propagate to the user's ID token the\n  // next time a new one is issued.\n});\n")),(0,r.kt)("p",null,"To verify the custom claims on the server the following must be done:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// Verify the ID token first.\nadmin.auth().verifyIdToken(idToken).then((claims) => {\n  if (claims.admin === true) {\n    // Allow access to requested admin resource.\n  }\n});\n")),(0,r.kt)("p",null,"On the frontend app you must do the following process:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"firebase.auth().currentUser.getIdTokenResult() // can also use await\n  .then((idTokenResult) => {\n     // Confirm the user is an Admin.\n     if (!!idTokenResult.claims.admin) {\n       // Show admin UI.\n       showAdminUI();\n     } else {\n       // Show regular user UI.\n       showRegularUI();\n     }\n  })\n  .catch((error) => {\n    console.log(error);\n  });\n")),(0,r.kt)("h2",{id:"stripe"},"Stripe"),(0,r.kt)("p",null,"La Stripe API est\xe1 basada en REST. Stripe API tiene URL orientadas a recursos predecibles, acepta cuerpos de solicitud codificados en forma, devuelve respuestas codificadas en JSON y utiliza c\xf3digos de respuesta HTTP est\xe1ndar y autenticaci\xf3n."),(0,r.kt)("p",null,"Stripe ofrece un SDK oficial que se puede integrar en el proyecto usando NPM."),(0,r.kt)("h3",{id:"api-keys-1"},"API keys"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Abra el dashboard Stripe."),(0,r.kt)("li",{parentName:"ol"},"En la barra izquierda, haga clic en Desarrolladores y elija las claves de API."),(0,r.kt)("li",{parentName:"ol"},"Copiar las claves p\xfablicas y secretas y a\xf1adirlas al servidor a trav\xe9s de variables de entorno.")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Aseg\xfarese de que est\xe1 copiando las claves de prueba, ya que las claves en vivo solo est\xe1n destinadas al entorno de producci\xf3n")),(0,r.kt)("p",null,"Para la integraci\xf3n se utilizar\xe1 el SDK oficial de Stripe, el cual se puede agregar\nal proyecto utilizando el siguiente comando:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"$ npm install stripe --save\n")),(0,r.kt)("p",null,"Para empezar a utilizar el paquete basta con agregar el siguiente c\xf3digo:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"const stripe = require('stripe')('sk_test_...');\n")),(0,r.kt)("h3",{id:"crear-intenci\xf3n-de-pago"},"Crear intenci\xf3n de Pago"),(0,r.kt)("p",null,"Para solicitar un pago por parte de un cliente, se crea un intento de pago en el servidor,\nesto devuelve un secreto que debe ser enviado a la aplicaci\xf3n cliente para verificar el\npago."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// Set your secret key: remember to change this to your live secret key in production\n// See your keys here: https://dashboard.stripe.com/account/apikeys\nconst stripe = require('stripe')('sk_test_4eC39HqLyjWDarjtT1zdp7dc');\n\n(async () => {\n  const paymentIntent = await stripe.paymentIntents.create({\n    amount: 1099,\n    currency: 'usd',\n  });\n})();\n")),(0,r.kt)("h3",{id:"crear-intenci\xf3n-de-configuraci\xf3n"},"Crear intenci\xf3n de configuraci\xf3n"),(0,r.kt)("p",null,"Permite crear una intenci\xf3n con el fin de registrar un m\xe9todo de pago sin realizar un cargo."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// Set your secret key: remember to change this to your live secret key in production\n// See your keys here: https://dashboard.stripe.com/account/apikeys\nconst stripe = require('stripe')('sk_test_4eC39HqLyjWDarjtT1zdp7dc');\n\n(async () => {\n  const setupIntent = await stripe.setupIntents.create({\n    customer: 'cus_9asd89797l23jld928hsdkc'\n  });\n})();\n")),(0,r.kt)("p",null,"El valor del secret del setupIntent se debe env\xedar al cliente para que complete el flujo, con el fin de\nregistrar el m\xe9todo de pago. Para verificar que el m\xe9todo se asocio de forma correcta, se debe escuchar el\nevento ",(0,r.kt)("strong",{parentName:"p"},"payment_method.attached"),"."),(0,r.kt)("h3",{id:"crear-un-cargo-recurrente"},"Crear un cargo recurrente"),(0,r.kt)("p",null,"Para crear un cargo recurrente, es necesario dar de alta un producto en Stripe, asociarle\nprecios dependiendo de la recurrencia de pago y por ultimo asociar un cliente a un producto\na trav\xe9s de una suscripci\xf3n."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"//crea el producto\nconst product = await stripe.products.create({\n  name: 'Weekly Car Wash Service',\n  type: 'service',\n});\n\n//asocia los distintos precios de acuerdo a la forma de suscripci\xf3n\nconst price = await stripe.prices.create({\n  nickname: 'Standard Monthly',\n  product: '{{CAR_WASH_PRODUCT_ID}}',\n  unit_amount: 2000,\n  currency: 'usd',\n  recurring: {\n    interval: 'month',\n    usage_type: 'LICENSED',\n  },\n});\n\n//crea la suscripcion del usuario al esquema de pago deseado\nconst subscription = await stripe.subscriptions.create({\n  customer: '{{CUSTOMER_ID}}',\n  items: [\n    {\n      price: '{{STANDARD_MONTHLY_USD_PRICE_ID}}',\n      quantity: 2,\n    },\n  ],\n});\n")),(0,r.kt)("h3",{id:"tokenizaci\xf3n-y-pagos-en-l\xednea"},"Tokenizaci\xf3n y pagos en l\xednea"),(0,r.kt)("p",null,"Stripe permite obtener la informaci\xf3n de la tarjeta de una forma segura sin tener la\nnecesidad de env\xedar la informaci\xf3n del cliente al servidor. Tambi\xe9n prove\xe9 sus propias\nformas para utilizarlas en la vista del cliente."),(0,r.kt)("p",null,"Pra utilizarlo hay que realizar el siguiente proceso:"),(0,r.kt)("p",null,"Agregar el script de Stripe a la cabecera de la p\xe1gina:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'<head>\n  <title>Checkout</title>\n  <script src="https://js.stripe.com/v3/"><\/script>\n</head>\n')),(0,r.kt)("p",null,"Crear una instancia de ",(0,r.kt)("em",{parentName:"p"},"Elements"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// Set your publishable key: remember to change this to your live publishable key in production\n// See your keys here: https://dashboard.stripe.com/account/apikeys\nvar stripe = Stripe('pk_test_TYooMQauvdEDq54NiTphI7jx');\nvar elements = stripe.elements();\n")),(0,r.kt)("p",null,"Agregar contenedores para los componentes de Elements:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'<form id="payment-form">\n  <div id="card-element">\n    \x3c!-- Elements will create input elements here --\x3e\n  </div>\n\n  \x3c!-- We\'ll put the error messages in this element --\x3e\n  <div id="card-errors" role="alert"></div>\n\n  <button id="submit">Pay</button>\n</form>\n')),(0,r.kt)("p",null,"Una vez que cargo la vista, crear una instancia de ",(0,r.kt)("em",{parentName:"p"},"Element")," y montarla en el conenedor:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'// Set up Stripe.js and Elements to use in checkout form\nvar style = {\n  base: {\n    color: "#32325d",\n  }\n};\n\nvar card = elements.create("card", { style: style });\ncard.mount("#card-element");\n')),(0,r.kt)("p",null,"Se recomienda escuchar los eventos del componente para ayudar al usuario a validar\nsus datos:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"card.addEventListener('change', ({error}) => {\n  const displayError = document.getElementById('card-errors');\n  if (error) {\n    displayError.textContent = error.message;\n  } else {\n    displayError.textContent = '';\n  }\n});\n")),(0,r.kt)("p",null,"Ejecutar el pago desde el lado del cliente con el secreto devuelto en el paso anterior:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"var form = document.getElementById('payment-form');\n\nform.addEventListener('submit', function(ev) {\n  ev.preventDefault();\n  stripe.confirmCardPayment(clientSecret, {\n    payment_method: {\n      card: card,\n      billing_details: {\n        name: 'Jenny Rosen'\n      }\n    }\n  }).then(function(result) {\n    if (result.error) {\n      // Show error to your customer (e.g., insufficient funds)\n      console.log(result.error.message);\n    } else {\n      // The payment has been processed!\n      if (result.paymentIntent.status === 'succeeded') {\n        // Show a success message to your customer\n        // There's a risk of the customer closing the window before callback\n        // execution. Set up a webhook or plugin to listen for the\n        // payment_intent.succeeded event that handles any business critical\n        // post-payment actions.\n      }\n    }\n  });\n});\n")),(0,r.kt)("h3",{id:"tarjetas-de-prueba"},"Tarjetas de prueba"),(0,r.kt)("p",null,"Stripe ofrece n\xfameros de tarjeta para probar ciertos comportamientos en el ambiente de Testing."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Tarjeta"),(0,r.kt)("th",{parentName:"tr",align:null},"Comportamiento"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"4242424242424242"),(0,r.kt)("td",{parentName:"tr",align:null},"Pago exitoso.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"4000000000009995"),(0,r.kt)("td",{parentName:"tr",align:null},"Saldo insuficiente.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"4000002500003155"),(0,r.kt)("td",{parentName:"tr",align:null},"Requiere autenticaci\xf3n, por lo que despliega un modal para que el usuario se autentique.")))))}d.isMDXComponent=!0}}]);